<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking Number Image Matcher</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-section.active {
            border-color: #28a745;
            background: #f0fff4;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .upload-button:hover {
            transform: translateY(-2px);
        }

        .search-section {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 20px;
            font-size: 1.2rem;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
        }

        .results-section {
            margin-top: 30px;
        }

        .order-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .order-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .detail-label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .image-number {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .no-image {
            background: #fff3cd;
            color: #856404;
            padding: 30px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            text-align: center;
            font-size: 1.1rem;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 1.1rem;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¶ Tracking Image Matcher</h1>
            <p>Upload your CSV and search for product images by tracking number</p>
        </div>
        
        <div class="content">
            <!-- Extension Status Banner -->
            <div id="extensionStatus" style="display: none; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 5px;">üîì Google Drive CORS Bypass Extension Active</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">Google Drive files will be downloaded directly through the extension</div>
            </div>
            
            <div id="extensionWarning" style="display: none; background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Chrome Extension Recommended</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">Install the Google Drive CORS Bypass extension for better file loading</div>
            </div>

            <div class="upload-section" id="uploadSection">
                <h3>üìÑ Upload CSV File</h3>
                <p>Select your orders CSV file to get started</p>
                <br>
                <input type="file" id="csvFile" class="file-input" accept=".csv">
                <button class="upload-button" onclick="document.getElementById('csvFile').click()">
                    Choose CSV File
                </button>
                <div id="uploadStatus"></div>
            </div>

            <div id="statsSection" style="display: none;">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ordersWithTracking">0</div>
                        <div class="stat-label">With Tracking</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ordersWithImages">0</div>
                        <div class="stat-label">With Images</div>
                    </div>
                </div>
            </div>

            <div class="search-section" id="searchSection" style="display: none;">
                <input 
                    type="text" 
                    id="trackingInput" 
                    class="search-input" 
                    placeholder="Enter tracking number and press Enter..."
                    autocomplete="off"
                >
            </div>

            <div id="resultsSection" class="results-section"></div>
        </div>
    </div>

    <script>
        let csvData = [];
        
        // File upload handling
        document.getElementById('csvFile').addEventListener('change', handleFileUpload);
        document.getElementById('trackingInput').addEventListener('keypress', handleSearch);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadSection = document.getElementById('uploadSection');
            const uploadStatus = document.getElementById('uploadStatus');
            
            uploadStatus.innerHTML = '<div class="loading"><div class="spinner"></div>Processing CSV file...</div>';
            uploadSection.classList.add('active');

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                delimitersToGuess: [',', '\t', '|', ';'],
                complete: function(results) {
                    if (results.errors.length > 0) {
                        uploadStatus.innerHTML = `<div class="error-message">Error parsing CSV: ${results.errors[0].message}</div>`;
                        return;
                    }

                    // Clean headers by removing whitespace
                    const cleanData = results.data.map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            const cleanKey = key.trim();
                            cleanRow[cleanKey] = row[key];
                        });
                        return cleanRow;
                    });

                    csvData = cleanData;
                    
                    uploadStatus.innerHTML = `<div class="success-message">‚úÖ Successfully loaded ${csvData.length} orders!</div>`;
                    
                    // Show stats and search section
                    updateStats();
                    document.getElementById('statsSection').style.display = 'block';
                    document.getElementById('searchSection').style.display = 'block';
                    document.getElementById('trackingInput').focus();
                },
                error: function(error) {
                    uploadStatus.innerHTML = `<div class="error-message">Error reading file: ${error.message}</div>`;
                }
            });
        }

        function updateStats() {
            const totalOrders = csvData.length;
            const ordersWithTracking = csvData.filter(order => order.tracking_number && order.tracking_number.toString().trim()).length;
            const ordersWithImages = csvData.filter(order => order.notes && extractGoogleDriveUrls(order.notes).length > 0).length;

            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('ordersWithTracking').textContent = ordersWithTracking;
            document.getElementById('ordersWithImages').textContent = ordersWithImages;
        }

        function handleSearch(event) {
            if (event.key === 'Enter') {
                const trackingNumber = event.target.value.trim();
                if (!trackingNumber) return;

                searchByTrackingNumber(trackingNumber);
            }
        }

        function searchByTrackingNumber(trackingNumber) {
            const resultsSection = document.getElementById('resultsSection');
            
            // Show loading
            resultsSection.innerHTML = '<div class="loading"><div class="spinner"></div>Searching for tracking number...</div>';

            // Find order with matching tracking number
            const order = csvData.find(row => {
                const orderTracking = row.tracking_number ? row.tracking_number.toString().trim() : '';
                return orderTracking === trackingNumber;
            });

            if (!order) {
                resultsSection.innerHTML = `
                    <div class="error-message">
                        ‚ùå No order found with tracking number: <strong>${trackingNumber}</strong>
                    </div>
                `;
                return;
            }

            displayOrderResults(order, trackingNumber);
        }

        function displayOrderResults(order, trackingNumber) {
            const resultsSection = document.getElementById('resultsSection');
            
            // Extract URLs from notes
            const imageUrls = order.notes ? extractGoogleDriveUrls(order.notes) : [];
            
            let html = `
                <div class="order-info">
                    <h3>üì¶ Order Found for Tracking: ${trackingNumber}</h3>
                    <div class="order-details">
                        <div class="detail-item">
                            <div class="detail-label">Order Number</div>
                            <div>${order.number || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Product Title</div>
                            <div>${order.product_title || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Quantity</div>
                            <div>${order.quantity || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Customer Email</div>
                            <div>${order.customer_email || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div>${order.status || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Price</div>
                            <div>$${order.total_price || '0.00'}</div>
                        </div>
                    </div>
            `;

            if (imageUrls.length === 0) {
                html += `
                    <div class="no-image">
                        üñºÔ∏è Image not found - No valid Google Drive URLs in order notes
                    </div>
                `;
            } else {
                html += `<div class="images-grid">`;
                imageUrls.forEach((url, index) => {
                    const directUrl = convertToDirectImageUrl(url);
                    html += `
                        <div class="image-container">
                            <div class="image-number">Image ${index + 1}</div>
                            <img src="${directUrl}" alt="Product Image ${index + 1}" 
                                 onload="this.style.opacity=1" 
                                 onerror="handleImageError(this, '${url}', ${index})"
                                 style="opacity:0; transition: opacity 0.3s ease;"
                                 data-original-url="${url}">
                        </div>
                    `;
                });
                html += `</div>`;
            }

            html += `</div>`;
            resultsSection.innerHTML = html;
        }

        function extractGoogleDriveUrls(notes) {
            if (!notes) return [];
            
            // Regular expression to match Google Drive URLs
            const driveUrlRegex = /https:\/\/drive\.google\.com\/file\/d\/[a-zA-Z0-9_-]+\/view\?usp=drive_link/g;
            const matches = notes.match(driveUrlRegex);
            
            return matches || [];
        }

        function convertToDirectImageUrl(driveUrl) {
            // Extract file ID from Google Drive URL
            const fileIdMatch = driveUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
            if (fileIdMatch) {
                const fileId = fileIdMatch[1];
                // Try thumbnail first for images
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
            }
            return driveUrl;
        }

        async function downloadAndDisplayFile(fileId, originalUrl, container, index) {
            try {
                // Show downloading status
                container.innerHTML = `
                    <div class="image-number">Image ${index + 1}</div>
                    <div style="
                        background: #f8f9fa; 
                        border-radius: 10px; 
                        padding: 40px 20px; 
                        text-align: center;
                        min-height: 400px;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                    ">
                        <div class="spinner" style="margin-bottom: 20px;"></div>
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 10px;">
                            Downloading file...
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            This may take a moment
                        </div>
                    </div>
                `;

                // Try multiple download URLs
                const downloadUrls = [
                    `https://drive.google.com/uc?export=download&id=${fileId}`,
                    `https://drive.google.com/uc?id=${fileId}&export=download`,
                    `https://drive.google.com/file/d/${fileId}/view?usp=drivesdk`
                ];

                let fileBlob = null;
                let fileType = null;

                for (const url of downloadUrls) {
                    try {
                        const response = await fetch(url, {
                            method: 'GET',
                            mode: 'cors'
                        });
                        
                        if (response.ok) {
                            fileBlob = await response.blob();
                            fileType = fileBlob.type;
                            break;
                        }
                    } catch (err) {
                        console.log(`Failed to fetch from ${url}:`, err);
                        continue;
                    }
                }

                if (!fileBlob) {
                    throw new Error('Could not download file from any URL');
                }

                // Create local URL for the downloaded file
                const localUrl = URL.createObjectURL(fileBlob);

                // Display based on file type
                if (fileType.includes('pdf')) {
                    displayPDF(localUrl, container, index, originalUrl);
                } else if (fileType.includes('image')) {
                    displayImage(localUrl, container, index, originalUrl);
                } else {
                    // Try to display as PDF first, then as image
                    displayPDF(localUrl, container, index, originalUrl);
                }

            } catch (error) {
                console.error('Download failed:', error);
                showDownloadError(container, originalUrl, index);
            }
        }

        function displayPDF(localUrl, container, index, originalUrl) {
            container.innerHTML = `
                <div class="image-number">Image ${index + 1} (PDF)</div>
                <div style="position: relative; background: #f8f9fa; border-radius: 10px; overflow: hidden;">
                    <object data="${localUrl}" type="application/pdf" width="100%" height="500">
                        <embed src="${localUrl}" type="application/pdf" width="100%" height="500">
                            <iframe src="${localUrl}" width="100%" height="500" style="border: none;">
                                <div style="padding: 40px; text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: 15px;">üìÑ</div>
                                    <div style="color: #667eea; font-weight: bold; margin-bottom: 10px;">
                                        PDF Downloaded Successfully
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <a href="${localUrl}" download style="
                                            background: #667eea;
                                            color: white;
                                            padding: 12px 24px;
                                            border-radius: 25px;
                                            text-decoration: none;
                                            display: inline-block;
                                            margin: 5px;
                                        ">üíæ Download PDF</a>
                                        <a href="${originalUrl}" target="_blank" style="
                                            background: #28a745;
                                            color: white;
                                            padding: 12px 24px;
                                            border-radius: 25px;
                                            text-decoration: none;
                                            display: inline-block;
                                            margin: 5px;
                                        ">üîó Open in Drive</a>
                                    </div>
                                </div>
                            </iframe>
                        </embed>
                    </object>
                </div>
            `;
        }

        function displayImage(localUrl, container, index, originalUrl) {
            container.innerHTML = `
                <div class="image-number">Image ${index + 1}</div>
                <div style="position: relative; background: #f8f9fa; border-radius: 10px; overflow: hidden; text-align: center; padding: 10px;">
                    <img src="${localUrl}" alt="Product Image ${index + 1}" 
                         style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.2);">
                    <div style="
                        position: absolute;
                        bottom: 15px;
                        right: 15px;
                        background: rgba(102, 126, 234, 0.9);
                        color: white;
                        padding: 8px 15px;
                        border-radius: 20px;
                        font-size: 0.9rem;
                        cursor: pointer;
                        transition: background 0.3s ease;
                    " onclick="window.open('${originalUrl}', '_blank')">
                        üîó Open in Drive
                    </div>
                </div>
            `;
        }

        function showDownloadError(container, originalUrl, index) {
            container.innerHTML = `
                <div class="image-number">Image ${index + 1}</div>
                <div style="
                    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                    color: white;
                    padding: 40px 20px;
                    border-radius: 10px;
                    text-align: center;
                    min-height: 400px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                ">
                    <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">
                        Download Failed
                    </div>
                    <div style="opacity: 0.9; margin-bottom: 20px;">
                        File may not be publicly accessible or has download restrictions
                    </div>
                    <div style="
                        background: rgba(255,255,255,0.2);
                        padding: 12px 20px;
                        border-radius: 25px;
                        cursor: pointer;
                        transition: background 0.3s ease;
                    " onclick="window.open('${originalUrl}', '_blank')"
                       onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        üîó Open File in Google Drive
                    </div>
                </div>
            `;
        }

        function handleImageError(imgElement, originalUrl, index) {
            const fileIdMatch = originalUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
            if (fileIdMatch) {
                const fileId = fileIdMatch[1];
                
                // Check if Chrome extension is available
                if (window.GoogleDriveCORSBypass && window.GoogleDriveCORSBypass.isExtensionActive) {
                    const container = imgElement.parentElement;
                    fetchFileWithExtension(fileId, originalUrl, container, index);
                    return;
                }
                
                // Try alternative image formats first
                const alternatives = [
                    `https://lh3.googleusercontent.com/d/${fileId}=w1000`,
                    `https://drive.google.com/uc?export=view&id=${fileId}`
                ];

                let attemptIndex = parseInt(imgElement.dataset.attempt || 0);
                
                if (attemptIndex < alternatives.length) {
                    imgElement.dataset.attempt = (attemptIndex + 1).toString();
                    imgElement.src = alternatives[attemptIndex];
                    return;
                }
                
                // If all image attempts failed, try downloading the file
                const container = imgElement.parentElement;
                downloadAndDisplayFile(fileId, originalUrl, container, index);
            }
        }

        // New function to use Chrome extension
        async function fetchFileWithExtension(fileId, originalUrl, container, index) {
            try {
                container.innerHTML = `
                    <div class="image-number">Image ${index + 1}</div>
                    <div style="
                        background: #f8f9fa; 
                        border-radius: 10px; 
                        padding: 40px 20px; 
                        text-align: center;
                        min-height: 400px;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                    ">
                        <div class="spinner" style="margin-bottom: 20px;"></div>
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 10px;">
                            üîì Extension downloading file...
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            Using Chrome extension to bypass CORS
                        </div>
                    </div>
                `;

                const result = await window.GoogleDriveCORSBypass.fetchFile(fileId, originalUrl);
                
                if (result.success) {
                    const dataUrl = `data:${result.mimeType};base64,${result.data}`;
                    
                    if (result.mimeType.includes('pdf')) {
                        displayExtensionPDF(dataUrl, container, index, originalUrl, result.size);
                    } else if (result.mimeType.includes('image')) {
                        displayExtensionImage(dataUrl, container, index, originalUrl, result.size);
                    } else {
                        // Try to display as PDF first, then as image
                        displayExtensionPDF(dataUrl, container, index, originalUrl, result.size);
                    }
                } else {
                    throw new Error(result.error || 'Extension failed to fetch file');
                }
                
            } catch (error) {
                console.error('Extension fetch failed:', error);
                showExtensionError(container, originalUrl, index, error.message);
            }
        }

        function displayExtensionPDF(dataUrl, container, index, originalUrl, fileSize) {
            const fileSizeText = fileSize ? ` (${(fileSize / 1024 / 1024).toFixed(1)} MB)` : '';
            container.innerHTML = `
                <div class="image-number">Image ${index + 1} (PDF)${fileSizeText}</div>
                <div style="position: relative; background: #f8f9fa; border-radius: 10px; overflow: hidden;">
                    <div style="
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        color: white;
                        padding: 10px;
                        text-align: center;
                        font-weight: bold;
                        margin-bottom: 10px;
                    ">
                        ‚úÖ Downloaded via Chrome Extension
                    </div>
                    <object data="${dataUrl}" type="application/pdf" width="100%" height="500">
                        <embed src="${dataUrl}" type="application/pdf" width="100%" height="500">
                            <iframe src="${dataUrl}" width="100%" height="500" style="border: none;">
                                <div style="padding: 40px; text-align: center;">
                                    <div style="font-size: 2rem; margin-bottom: 15px;">üìÑ</div>
                                    <div style="color: #667eea; font-weight: bold; margin-bottom: 10px;">
                                        PDF Downloaded Successfully
                                    </div>
                                    <div style="margin-bottom: 20px;">
                                        <a href="${dataUrl}" download style="
                                            background: #667eea;
                                            color: white;
                                            padding: 12px 24px;
                                            border-radius: 25px;
                                            text-decoration: none;
                                            display: inline-block;
                                            margin: 5px;
                                        ">üíæ Download PDF</a>
                                        <a href="${originalUrl}" target="_blank" style="
                                            background: #28a745;
                                            color: white;
                                            padding: 12px 24px;
                                            border-radius: 25px;
                                            text-decoration: none;
                                            display: inline-block;
                                            margin: 5px;
                                        ">üîó Open in Drive</a>
                                    </div>
                                </div>
                            </iframe>
                        </embed>
                    </object>
                </div>
            `;
        }

        function displayExtensionImage(dataUrl, container, index, originalUrl, fileSize) {
            const fileSizeText = fileSize ? ` (${(fileSize / 1024 / 1024).toFixed(1)} MB)` : '';
            container.innerHTML = `
                <div class="image-number">Image ${index + 1}${fileSizeText}</div>
                <div style="position: relative; background: #f8f9fa; border-radius: 10px; overflow: hidden; text-align: center; padding: 10px;">
                    <div style="
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        color: white;
                        padding: 8px;
                        border-radius: 5px;
                        font-weight: bold;
                        margin-bottom: 10px;
                        font-size: 0.9rem;
                    ">
                        ‚úÖ Downloaded via Chrome Extension
                    </div>
                    <img src="${dataUrl}" alt="Product Image ${index + 1}" 
                         style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.2);">
                    <div style="
                        position: absolute;
                        bottom: 15px;
                        right: 15px;
                        background: rgba(102, 126, 234, 0.9);
                        color: white;
                        padding: 8px 15px;
                        border-radius: 20px;
                        font-size: 0.9rem;
                        cursor: pointer;
                        transition: background 0.3s ease;
                    " onclick="window.open('${originalUrl}', '_blank')">
                        üîó Open in Drive
                    </div>
                </div>
            `;
        }

        function showExtensionError(container, originalUrl, index, errorMessage) {
            container.innerHTML = `
                <div class="image-number">Image ${index + 1}</div>
                <div style="
                    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                    color: white;
                    padding: 40px 20px;
                    border-radius: 10px;
                    text-align: center;
                    min-height: 400px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                ">
                    <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">
                        Extension Download Failed
                    </div>
                    <div style="opacity: 0.9; margin-bottom: 10px; font-size: 0.9rem;">
                        ${errorMessage}
                    </div>
                    <div style="opacity: 0.8; margin-bottom: 20px; font-size: 0.8rem;">
                        File may not be publicly accessible or has download restrictions
                    </div>
                    <div style="
                        background: rgba(255,255,255,0.2);
                        padding: 12px 20px;
                        border-radius: 25px;
                        cursor: pointer;
                        transition: background 0.3s ease;
                    " onclick="window.open('${originalUrl}', '_blank')"
                       onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                       onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        üîó Open File in Google Drive
                    </div>
                </div>
            `;
        }



        // Extension detection and status display
        function checkExtensionStatus() {
            // Check if extension API is available
            if (window.GoogleDriveCORSBypass) {
                window.GoogleDriveCORSBypass.checkExtension().then((isActive) => {
                    if (isActive) {
                        document.getElementById('extensionStatus').style.display = 'block';
                        document.getElementById('extensionWarning').style.display = 'none';
                    } else {
                        document.getElementById('extensionStatus').style.display = 'none';
                        document.getElementById('extensionWarning').style.display = 'block';
                    }
                });
            } else {
                // Extension not available, show warning
                document.getElementById('extensionStatus').style.display = 'none';
                document.getElementById('extensionWarning').style.display = 'block';
            }
        }

        // Listen for extension ready event
        window.addEventListener('googleDriveCORSBypassReady', function(event) {
            if (event.detail.extensionActive) {
                document.getElementById('extensionStatus').style.display = 'block';
                document.getElementById('extensionWarning').style.display = 'none';
            }
        });

        // Auto-focus search input when page loads
        window.addEventListener('load', () => {
            const trackingInput = document.getElementById('trackingInput');
            if (trackingInput.style.display !== 'none') {
                trackingInput.focus();
            }
            
            // Check extension status after a short delay
            setTimeout(checkExtensionStatus, 1000);
        });

        // Periodically check extension status
        setInterval(checkExtensionStatus, 5000);
    </script>
</body>
</html>
